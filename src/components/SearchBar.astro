---
import IconBookmarks from "./IconBookmarks.astro";
import IconPeople from "./IconPeople.astro";
import IconPlaces from "./IconPlaces.astro";

const { activeProject } = Astro.props;

// Get project posts
const posts = await Astro.glob('../pages/*/*/*.md');
let filteredPosts;

// Determine post filtering
if (activeProject){
    filteredPosts = posts.filter(post => {
        return post.url.includes(`${activeProject.toLowerCase()}`);
    })
} else {
    filteredPosts = posts;
}

// TODO - Add up/down arrow key handlers for search bar


---

<div class="search-group accordion">
    <form id="search-form">
        <input id="search-input" class="text-field" type="search" minlength="3" placeholder={activeProject ? `Search articles in ${activeProject}` : 'Search articles'} autocomplete="off"/>
        <!-- <button id="search-clear" type="button" aria-label="Clear Search">
            <svg viewbox="0 0 32 32">
                <line y1="16" x1="0" y2="16" x2="32"/>
                <line y1="16" x1="0" y2="16" x2="32"/>
            </svg>
        </button> -->
        <button id="search-submit" class="submit" type="button" >
            <svg class="search-submit-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <circle cx="9.5" cy="9.5" r="7.5"/>
                <line x1="14.8" y1="14.8" x2="22" y2="22"/>
            </svg>
        </button>
    </form>
    <!-- <form id="sort">
        <label>Sort by</label>
        <select name="sort" id="sort-select">
        <option value="byRelevance" hidden>Relevance</option>
        <option value="byDateAdded" selected="selected">Date Added</option>
        </select>
    </form> -->

    <div id="search-results" hidden></div>
</div>

<script define:vars={{filteredPosts}}>

    // Store index of posts
    let index = filteredPosts;

    console.log(index);

    // Get DOM elements
    let searchForm = document.querySelector('#search-form');
    let searchInput = document.querySelector('#search-input');
    let searchResults = document.querySelector('#search-results');

    let stopWords = ['a', 'an', 'and', 'are', 'aren\'t', 'as', 'by', 'can', 'cannot', 'can\'t', 'could', 'couldn\'t', 'how', 'is', 'isn\'t', 'it', 'its', 'it\'s', 'that', 'the', 'their', 'there', 'they', 'they\'re', 'them', 'to', 'too', 'us', 'very', 'was', 'we', 'well', 'were', 'what', 'whatever', 'when', 'whenever', 'where', 'with', 'would', 'yet', 'you', 'your', 'yours', 'yourself', 'yourselves', 'the'];

    // Make sure required content exists
    if (!searchForm || !searchInput || !searchResults || !index) return;

    searchForm.addEventListener('submit', function(event){
        // Prevents default submit server call and triggers search function
        event.preventDefault();
        search(searchInput.value);
        searchResults.removeAttribute('hidden');
    })

    searchForm.addEventListener('input', function(event){
        if (searchInput.value.length > 2){
            search(searchInput.value);
            searchResults.removeAttribute('hidden');
        } else {
            searchResults.setAttribute('hidden', '');
        }
    })

    let search = function(query) {

        // Create a regex for each query
        let regMap = query.toLowerCase().split(' ').filter((word) => {
            return word.length && !stopWords.includes(word);
        }).map((word) => {
            return new RegExp(word, 'i');
        });

        console.log(regMap);
        
        // Get and sort the results
        let results = index.reduce((results, post, index) => {

            // Setup priority count
            let priority = 0;

            // Assign priority
            for (let reg of regMap) {
                if (reg.test(post.frontmatter.title)) { priority += 100 }
                // let occurences = post.content.match(reg);
                // if (occurences) { priority += occurences.length; }
            }

            // If any matches, push to results
            if (priority > 0) {
                results.push({
                    priority: priority,
                    post: post
                });
            }

            return results;

        }, []).sort((post1, post2) => {
            return post1.priority - post2.priority;
        });

        // Display the results
        showResults(results);

    }

    let svgs = {
        people: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <circle vector-effect="non-scaling-stroke" cx="12" cy="5.5" r="4.5"/>
    <path vector-effect="non-scaling-stroke" d="m2 22.18 2.32-6.95c.41-1.23 1.55-2.05 2.85-2.05h9.68c1.29 0 2.44.83 2.85 2.05l2.32 6.95"/>
</svg>`,
        groups: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <circle vector-effect="non-scaling-stroke" cx="15.08" cy="15.08" r="7.92"/>
    <circle vector-effect="non-scaling-stroke" cx="8.92" cy="8.92" r="7.92"/>
</svg>`,
        places: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path vector-effect="non-scaling-stroke" d="M11.93 5.86h.01c1.78 0 3.23 1.45 3.24 3.24 0 1.79-1.44 3.25-3.23 3.25h-.03c-1.78 0-3.23-1.46-3.23-3.25s1.45-3.24 3.24-3.24Z"/>
    <path vector-effect="non-scaling-stroke" d="M12 1c4.5 0 8.15 3.69 8.15 8.23 0 1.97-.29 3.33-1.39 5.12-.83 1.35-4.24 5.96-5.88 8.16-.44.59-1.32.59-1.76 0-1.63-2.2-5.05-6.81-5.88-8.16-1.11-1.79-1.4-3.15-1.39-5.12C3.85 4.69 7.5 1 12 1Z"/>
</svg>`,
        events: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <circle vector-effect="non-scaling-stroke" cx="12" cy="12" r="11"/>
    <path vector-effect="non-scaling-stroke" d="M11.5 12.5V5M11.5 12.5h6"/>
</svg>`,
        things: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path vector-effect="non-scaling-stroke" d="m1.5 5.63 10.5 4.7M12 1 1.5 5.63v12.74L12 23l10.5-4.63V5.63L12 1zM22.5 5.63 12 10.33M12 10.33V23"/>
</svg>`,
        bookmarks: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path vector-effect="non-scaling-stroke" d="m4.84 22.61 6.82-6.3c.19-.18.49-.18.68 0l6.82 6.3c.32.3.84.07.84-.37V1.5c0-.28-.22-.5-.5-.5h-15c-.28 0-.5.22-.5.5v20.75c0 .44.52.66.84.37Z"/> 
</svg>`
    }

    let showResults = function(results) {

        let myTemplate = function(results) {
            return results.map((match) => {
                let category = match.post.url.split('/')[2];
                return `<a href="${match.post.url}">${svgs[category]}<span>${match.post.frontmatter.title}</span>${svgs.bookmarks}</a>`
            }).join('')
        }

        if (results.length) {
            console.log(results);
            searchResults.innerHTML = myTemplate(results);
        } else {
            searchResults.innerHTML = `<p>No matches were found.</p>`;
        }
    }

</script>